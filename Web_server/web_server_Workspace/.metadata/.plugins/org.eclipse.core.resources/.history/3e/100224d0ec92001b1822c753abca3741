package admin.controller;

import java.io.IOException;

import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import common.MvcUtils;
import member.model.service.MemberService;
import member.model.vo.Member;


/**
 * Servlet implementation class AdminMemberFinderServlet
 */
@WebServlet("/admin/memberFinder")
public class AdminMemberFinderServlet extends HttpServlet {
	private static final long serialVersionUID = 1L;
	private MemberService memberService = new MemberService();

	/**
	 * @see HttpServlet#doGet(HttpServletRequest request, HttpServletResponse response)
	 */
	protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		//1. 사용자입력값 처리 :현재 페이지 cPage
		String searchType = request.getParameter("searchType");
		String searchKeyword = request.getParameter("searchKeyword");
		final int numPerPage = 10;	 //10페이지 
		int cPage = 1;	//1페이지 
		try {
			 cPage=Integer.parseInt(request.getParameter("cPage"));
		}catch(NumberFormatException e){
				//처리코드 없음.  기본값 1유지
		}
		//key value  String값 전달  
		Map<String, String> param = new HashMap<>();
		param.put("searchType", searchType);
		param.put("searchKeyword", searchKeyword);
		
		
		
		System.out.println("param@servlet = " + param);
		
		//2. 업무 로직
		
		
		int end = cPage * numPerPage;
//		int start = end - (numPerPage - 1);
		int start = (cPage -1) * numPerPage + 1;
		List<Member> list = memberService.searchMember(param,end,start);
		System.out.println("list@servlet = "+list);
		int totalContents = memberService.selectMemberCount() ;
		System.out.println("totalContents@servlet = " + totalContents);
		//3. pageBar영역 작업
		//param@servlet = {searchType=null, cPage=4, numPerPage=10, searchKeyword=null}
		String url =request.getRequestURI()+"?seacrchType"+searchType+"&searchKeyword" +searchKeyword;
		String pageBar =MvcUtils.getPageBar(cPage, numPerPage, totalContents, url);
	
		/**
		 * @실습문제 : 관리자 회원검색에 페이징 적용하기
			검색타입과 검색어가 페이징 이동중에도 유지되어야 한다.
			검색타입/검색어에 따라 totalContents가 매번 변경된다.
		 */
		//4. jsp에 html응답메세지 작성 위임
		request.setAttribute("pageBar",pageBar);
		request.setAttribute("list", list);
		request.getRequestDispatcher("/WEB-INF/views/admin/memberList.jsp")
		   .forward(request, response);		
	}

}